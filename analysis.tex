\chapter{Analysis}

\section{Local Types}
$\OuterGlobalTypeProjection{k} = \End$ for every $k$.

$\GlobalTypeProjection{i} = \LocalTypeProposer = \Mu{x}
\DotForall{j \in \AQ}{\SendUnreliableL{j}{\LOneA}{\mathbb{N}}} .
\DotForall{j \in \AQ}{\ReceiveUnreliableL{j}{\LOneB}{\Promise{\Value}}} .\\
\Indent{1}\SendWeaklyL{\AQ}{\Accept . \DotForall{j \in \AQ}{\SendUnreliableL{j}{\LTwoA}{\Proposal{\Value}}}.\End \oplus \Restart . x \oplus \Abort .\End}$

$\GlobalTypeProjection{j} = \LocalTypeAcceptor = \Mu{x}
\ReceiveUnreliableL{i}{\LOneA}{\mathbb{N}} .
\SendUnreliableL{i}{\LOneB}{\Promise{\Value}} .\\
\Indent{1}\ReceiveWeaklyL{i}{\Accept . \ReceiveUnreliableL{i}{\LTwoA}{\Proposal{\Value}}.\End \oplus \Restart . x \oplus \Abort .\End}$

\section{Type Check}
\subsection{System Initialization}
$\Gamma = \GEnvEntry{a}{\OuterGlobalType} \cdot \GEnvEntry{b_{ac+1}}{\GlobalType} \cdot \GEnvEntry{b_{ac+2}}{\GlobalType} \cdot \ldots \cdot \GEnvEntry{b_{ac+pc}}{\GlobalType}$.

\begin{prooftree}
\AxiomC{$\SysProof{1}$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{a}{2}{t}\ldots \vartriangleright \emptyset$}

\AxiomC{$\SysProof{2}$}
\UnaryInfC{$\Gamma\vdash \SessionAccept{a}{1}{t} \ldots \vartriangleright \emptyset$}

\AxiomC{$\SysProof{3}$}
\UnaryInfC{$\Gamma\vdash \ParallelFor{1 \leq j \leq ac} \PaInitShort \vartriangleright \emptyset$}

\RightLabel{$\RPar$}
\BinaryInfC{$\Gamma\vdash \SessionAccept{a}{1}{t} \ldots \Or \ParallelFor{1 \leq j \leq ac} \PaInitShort \vartriangleright \emptyset$}

\RightLabel{$\RPar$}
\BinaryInfC{$\Gamma\vdash \SessionRequest{a}{2}{t}.\PpInitShort \Or \SessionAccept{a}{1}{t} \ldots \Or \ParallelFor{1 \leq j \leq ac} \PaInitShort \vartriangleright \emptyset$}
\end{prooftree}

\subsubsection{$\SysProof{1}$}
\begin{prooftree}
\AxiomC{$\ProposerProof{}$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{b_{ac+pc}}{ac+1}{s}.\Pp{} \vartriangleright \SEnvEntry{t}{2}{\OuterGlobalTypeProjection{2}}$}

\LeftLabel{$\SysProof{1} =$}
\RightLabel{$\RRec$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{a}{2}{t}.\PpInit{ac+1}{\genAq{ac+pc}{ac}{pc}}{ac+pc}{ac+pc}{[]} \vartriangleright \emptyset$}
\end{prooftree}

Since $\OuterGlobalTypeProjection{2} = \End$, $\SEnvEntry{t}{2}{\OuterGlobalTypeProjection{2}} = \emptyset$.
This is relevant later when continuing proof $\ProposerProof{}$.

\subsubsection{$\SysProof{2}$}
\begin{prooftree}
\AxiomC{$\ProposerProof{}$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{b_{ac+1}}{ac+1}{s}.\Pp{} \vartriangleright \emptyset$}

\AxiomC{$\ldots$}

\AxiomC{$\ProposerProof{}$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{b_{ac+pc-1}}{ac+1}{s}.\Pp{} \vartriangleright \emptyset$}

\RightLabel{$\RPar^{??}$}
\TrinaryInfC{$\Gamma\vdash \ParallelFor{ac < k < ac+pc} \PpInit{ac+1}{\genAq{k}{ac}{pc}}{k}{k}{[]} \vartriangleright \SEnvEntry{t}{1}{G\upharpoonright_1}$}

\LeftLabel{$\SysProof{2} =$}
\RightLabel{$\RAcc$}
\UnaryInfC{$\Gamma\vdash \SessionAccept{a}{1}{t} . \ParallelFor{ac < k < ac+pc} \PpInitShort \vartriangleright \emptyset$}
\end{prooftree}

Because $\OuterGlobalTypeProjection{1} = \End$, $\SEnvEntry{t}{1}{\OuterGlobalTypeProjection{1}} = \emptyset$.
So $\Delta$ for each proposer is empty at this point.

\subsubsection{$\SysProof{3}$}
\begin{prooftree}
\AxiomC{$\AcceptorProof{}$}
\UnaryInfC{$\Gamma\vdash \PaOne \vartriangleright \SEnvEntry{s}{j}{\GlobalTypeProjection{j}}$}
\RightLabel{$\RAcc$}
\UnaryInfC{$\Gamma\vdash\SessionAccept{b_{k}}{j}{s}.\PaOne\vartriangleright\emptyset$}
\AxiomC{$\ldots$}
\RightLabel{$\RPar^*$}
\BinaryInfC{$\Gamma\vdash\ParallelFor{ac < k \le ac + pc} \SessionAccept{b_k}{ac}{s} . \PaOne\vartriangleright\emptyset$}
\AxiomC{$\ldots$}

\LeftLabel{$\SysProof{3} =$}
\RightLabel{$\RPar^*$}
\BinaryInfC{$\Gamma\vdash\ParallelFor{1\leq j\leq ac} \left(\ParallelFor{ac < k \le ac + pc} \SessionAccept{b_k}{j}{s} . \PaOne\right) \vartriangleright\emptyset$}
\end{prooftree}

\subsection{Proposer}
For simplicity, let $i = ac + 1, \AQ = \genAq{y}{ac}{pc}, n = y, m = y, \VectorV = []$ where $ac < y \leq ac + pc$.
From that we know that $\Gamma = \Gamma' \cdot i:\mathbb{N} \cdot n:\mathbb{N} \cdot m:\mathbb{N}$.
% so just the arguments for a proposer y.

$\TpAccept = \DotForall{j \in \AQ}{\SendUnreliableL{j}{\LTwoA}{\Proposal{\Value}}}.\End$

$\TpBranch = \SendWeaklyL{\AQ}{\Accept . \TpAccept \oplus \Restart . x \oplus \Abort .\End}$

$e = \anyNack{\VectorV} \tOr \promiseCount{\VectorV} < \ceil{\frac{i}{2}}$

$pn = \proposalNumber{n}{m}$

$\Gamma'=\Gamma\cdot\GEnvEntry{X}{x}$

$\Gamma'' = \Gamma' \cdot \GEnvEntry{v_j}{\Promise{\Value}}$ for $j\in\AQ$

$prop = \ProposalC{\proposalNumber{n}{m}}{\promiseValue{\VectorV}}$

\subsubsection{$\ProposerProof{}$}
\begin{prooftree}
\AxiomC{$\ProposerProofTrue$}
\UnaryInfC{$\Gamma'' \vdash \SendWeaklyP{s}{i}{\AQ}{\Restart}{X} \vartriangleright \SEnvEntry{s}{i}{\TpBranch}$}

\AxiomC{$\ProposerProofFalse$}
\UnaryInfC{$\Gamma'' \vdash \SendWeaklyP{s}{i}{\AQ}{\Accept}{\ldots} \vartriangleright \SEnvEntry{s}{i}{\TpBranch}$}

\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma'' \vdash \If{e} \Then{\SendWeaklyP{s}{i}{\AQ}{\Restart}{X}} \Else{\SendWeaklyP{s}{i}{\AQ}{\Accept}{\ldots}} \vartriangleright \SEnvEntry{s}{i}{\TpBranch}$}

\RightLabel{$\RUget^{|\AQ|}$}
\UnaryInfC{$\Gamma' \vdash \DotForall{j \in \AQ}{\ReceiveUnreliableP{s}{j}{i}{\LOneB}{\bot}{v_j}} \ldots \vartriangleright \SEnvEntry{s}{i}{\DotForall{j \in \AQ}{\ReceiveUnreliableL{j}{\LOneB}{\Promise{\Value}}}}$}

\RightLabel{$\RUsend^{|\AQ|}$}
\UnaryInfC{$\Gamma' \vdash \DotForall{j \in \AQ}{\SendUnreliableP{s}{i}{j}{\LOneA}{pn}} \ldots \vartriangleright \SEnvEntry{s}{i}{\DotForall{j\in\AQ}{\SendUnreliableL{j}{\LOneA}{\mathbb{N}}}\ldots}$}

\RightLabel{$?$}
\UnaryInfC{$\Gamma' \vdash \update{n}{n+1} \ldots \vartriangleright \SEnvEntry{s}{i}{\DotForall{j\in\AQ}{\SendUnreliableL{j}{\LOneA}{\mathbb{N}}}\ldots}$}

\RightLabel{$\RRec$}
\UnaryInfC{$\Gamma\vdash \Mu{X} \update{n}{n + 1} \ldots \vartriangleright \SEnvEntry{s}{i}{\Mu{x}\DotForall{j\in\AQ}{\SendUnreliableL{j}{\LOneA}{\mathbb{N}}}\ldots}$}

\LeftLabel{$\ProposerProof{} =$}
\RightLabel{$\RReq$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{b_n}{i}{s}.\Pp{} \vartriangleright \emptyset$}
\end{prooftree}

\subsubsection{$\ProposerProofTrue$}
\begin{prooftree}
\AxiomC{}
\RightLabel{$\RVar$}
\UnaryInfC{$\Gamma\vdash X \vartriangleright \SEnvEntry{s}{i}{x}$}
\LeftLabel{$\ProposerProofTrue =$}
\RightLabel{$\RWsel$}
\UnaryInfC{$\Gamma\vdash \SendWeaklyP{s}{i}{\AQ}{\Restart}{X} \vartriangleright \SEnvEntry{s}{i}{\SendWeaklyL{\AQ}{\Accept . \TpAccept \oplus \Restart . x \oplus \Abort .\End}}$}
\end{prooftree}

\subsubsection{$\ProposerProofFalse$}
\begin{prooftree}
\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma\vdash \End \vartriangleright \SEnvEntry{s}{i}{\End}$}
\UnaryInfC{$\Gamma\vdash \DotForall{j \in \AQ}{\SendUnreliableP{s}{i}{j}{\LTwoA}{prop}}.\End \vartriangleright \SEnvEntry{s}{i}{\DotForall{j \in \AQ}{\SendUnreliableL{j}{\LTwoA}{\Proposal{\Value}}}.\End}$}

\LeftLabel{$\ProposerProofFalse =$}
\RightLabel{$\RWsel$}
\UnaryInfC{$\Gamma\vdash \SendWeaklyP{s}{i}{\AQ}{\Accept.\ldots} \vartriangleright \SEnvEntry{s}{i}{\SendWeaklyL{\AQ}{\Accept . \TpAccept \oplus \Restart . x \oplus \Abort .\End}}$}
\end{prooftree}

\subsection{Acceptor}
$\Gamma'=\Gamma\cdot\GEnvEntry{X}{x}$

$i = ac + 1$

$\PaAccept = \ReceiveUnreliableP{s}{i}{j}{\LTwoA}{\bot}{pr'} .
\If{pr' = \bot}\\
\Indent{1}\Then{\End}\\
\Indent{1}\Else{
    \If{\greaterEqual{\nFromProposal{pr'}}{n}}\\
    \Indent{2}\Then{\update{pr}{pr'} . \update{n}{\Just{\nFromProposal{pr'}}}.\End}\\
    \Indent{2}\Else{\End}}$

% TODO "Note that PaTwo = ... PaAccept"

$\Pa{t} = \update{n}{n'}.\SendUnreliableP{s}{j}{i}{\LOneB}{\Promise{pr}}.\PaTwo$

$\Pa{f} = \SendUnreliableP{s}{j}{i}{\LOneB}{\Nack{n}}.\PaTwo$

$\Pa{gt} = \If{\greaterThan{n'}{n}}\Then{\Pa{t}}\Else{\Pa{f}}$

% TODO "Not that PaOne = ... PaTwo ... Pagt"

$\LocalTypeAcceptor = \GlobalTypeProjection{j}$

$\TaAccept = \ReceiveUnreliableL{i}{\LTwoA}{\Proposal{\Value}}.\End$

$\TaBranch = \ReceiveWeaklyL{i}{\Accept . \TaAccept \oplus \Restart . x \oplus \Abort .\End}$

$\TaOneB = \SendUnreliableL{i}{\LOneB}{\Promise{\Value}} . \TaBranch$

\subsubsection{$\AcceptorProof{}$}
\begin{prooftree}
\AxiomC{$\AcceptorProofCont$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaTwo \vartriangleright \SEnvEntry{s}{j}{\TaBranch}$}
\RightLabel{$\RUsend$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \SendUnreliableP{s}{j}{i}{\LOneB}{\bot}.\PaTwo \vartriangleright \SEnvEntry{s}{j}{\TaOneB}$}

\AxiomC{$\AcceptorProof{gt}$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \Pa{gt} \vartriangleright \SEnvEntry{s}{j}{\TaOneB}$}

\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \If{n'=\bot}\Then{\PaTwo}\Else{\If{\greaterThan{n'}{n}}\ldots} \vartriangleright \SEnvEntry{s}{j}{\TaOneB}$}

\RightLabel{$\RUget$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x} \vdash \ReceiveUnreliableP{s}{i}{j}{\LOneA}{\bot}{n'}.\If{n'=\bot}\ldots \vartriangleright \SEnvEntry{s}{j}{\ReceiveUnreliableL{i}{\LOneA}{\mathbb{N}}.\TaOneB}$}

\LeftLabel{$\AcceptorProof{} =$}
\RightLabel{$\RRec$}
\UnaryInfC{$\Gamma\vdash \Mu{X} \ReceiveUnreliableP{s}{i}{j}{\LOneA}{\bot}{n'}.\ldots \vartriangleright \SEnvEntry{s}{j}{\Mu{x}\ReceiveUnreliableL{i}{\LOneA}{\mathbb{N}}.\ldots}$}
\end{prooftree}

\subsubsection{$\AcceptorProof{gt}$}
\begin{prooftree}
\AxiomC{$\AcceptorProofTrue$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \Pa{t} \vartriangleright \SEnvEntry{s}{j}{\TaOneB}$}

\AxiomC{$\AcceptorProofFalse$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \Pa{f} \vartriangleright \SEnvEntry{s}{j}{\TaOneB}$}

\LeftLabel{$\AcceptorProof{gt} =$}
\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \If{\greaterThan{n'}{n}}\Then{\Pa{t}}\Else{\Pa{f}} \vartriangleright \SEnvEntry{s}{j}{\TaOneB}$}
\end{prooftree}

\subsubsection{$\AcceptorProofTrue$}
\begin{prooftree}
\AxiomC{$\AcceptorProofCont$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaTwo \vartriangleright \SEnvEntry{s}{j}{\TaBranch}$}
\LeftLabel{$\AcceptorProofTrue =$}
\RightLabel{$\RUsend$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \SendUnreliableP{s}{j}{i}{\LOneB}{\Nack{n}}.\PaTwo \vartriangleright \SEnvEntry{s}{j}{\SendUnreliableL{i}{\LOneB}{\Promise{\Value}} . \TaBranch}$}
\end{prooftree}

\subsubsection{$\AcceptorProofFalse$}
\begin{prooftree}
\AxiomC{$\AcceptorProofCont$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaTwo \vartriangleright \SEnvEntry{s}{j}{\TaBranch}$}
\LeftLabel{$\AcceptorProofFalse =$}
\RightLabel{$\RUsend$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \SendUnreliableP{s}{j}{i}{\LOneB}{\Nack{n}}.\PaTwo \vartriangleright \SEnvEntry{s}{j}{\SendUnreliableL{i}{\LOneB}{\Promise{\Value}}.\TaBranch}$}
\end{prooftree}

\subsubsection{$\AcceptorProofCont$}
\begin{prooftree}
\AxiomC{$\AcceptorProofAccept$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaAccept \vartriangleright \SEnvEntry{s}{j}{\TaAccept}$}

\AxiomC{}
\RightLabel{$\RVar$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash X \vartriangleright \SEnvEntry{s}{j}{x}$}

\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \End \vartriangleright \SEnvEntry{s}{j}{\End}$}

\LeftLabel{$\AcceptorProofCont =$}
\RightLabel{$\RWbran$}
\TrinaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaTwo \vartriangleright \SEnvEntry{s}{j}{\TaBranch}$}
\end{prooftree}

\subsubsection{$\AcceptorProofAccept$}
\begin{prooftree}
\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma'\vdash \End \vartriangleright \SEnvEntry{s}{j}{\End}$}

\AxiomC{$\AcceptorProof{update}$}
\UnaryInfC{$\Gamma'\vdash\update{pr}{pr'}.\ldots \vartriangleright \SEnvEntry{s}{j}{\End}$}

\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma'\vdash \End \vartriangleright \SEnvEntry{s}{j}{\End}$}

\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma'\vdash \If{\greaterEqual{\nFromProposal{pr'}}{n}}\Then{\ldots}\Else{\End} \vartriangleright \SEnvEntry{s}{j}{\End}$}

\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma'\vdash \If{pr'=\bot}\Then{\End}\Else{\ldots} \vartriangleright \SEnvEntry{s}{j}{\End}$}
\LeftLabel{$\AcceptorProofAccept =$}
\RightLabel{$\RUget$}
\UnaryInfC{$\Gamma'\vdash \ReceiveUnreliableP{s}{i}{j}{\LTwoA}{\bot}{pr'}.\ldots \vartriangleright \SEnvEntry{s}{j}{\ReceiveUnreliableL{i}{\LTwoA}{\Proposal{\Value}}.\End}$}
\end{prooftree}

\subsubsection{$\AcceptorProof{update}$}
\begin{prooftree}
\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma'\vdash \End \vartriangleright \SEnvEntry{s}{j}{\End}$}
\RightLabel{$??$}
\UnaryInfC{$\Gamma'\vdash \update{n}{\Just{\nFromProposal{pr'}}}.\End \vartriangleright \SEnvEntry{s}{j}{\End}$}
\LeftLabel{$\AcceptorProof{update} =$}
\RightLabel{$??$}
\UnaryInfC{$\Gamma'\vdash\update{pr}{pr'}.\ldots \vartriangleright \SEnvEntry{s}{j}{\End}$}
\end{prooftree}
