\chapter{Analysis}
We take the model from the previous chapter, type-check it, and discuss what the type check means for agreement, validity, and termination of the Paxos algorithm.
To execute the type check we project the global type to local types and use the typing rules given in \cite{ftmpst} to proof that our model can be derived from them.

\section{Local Types}
% TODO Elaborate on this.
$\OuterGlobalTypeProjection{k} = \End$ for every $k$.

% paxos has roles proposer and acceptor
% therefore we have one local type for each
% proposer i and acceptor j

For $1 \leq \AcceptorIndex \leq ac$ and $ac + 1 \leq \ProposerIndex \leq ac + pc$ we define the projections of the global type $\GlobalType$.

$\GlobalTypeProjection{\ProposerIndex} = \Mu{x}
\DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableL{\AcceptorIndex}{\LOneA}{\mathbb{N}}} .
\DotForall{\AcceptorIndex\in\AQ}{\ReceiveUnreliableL{\AcceptorIndex}{\LOneB}{\Promise{\Value}}} .\\
\Indent{1}\SendWeaklyL{\AQ}{\Accept . \DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableL{\AcceptorIndex}{\LTwoA}{\Proposal{\Value}}}.\End \oplus \Restart . x \oplus \Abort .\End}$

$\GlobalTypeProjection{\ProposerIndex}$ defines the local type for proposers.
We can see that the proposer communicates with all acceptors in its quorum in every phase.

$\GlobalTypeProjection{\AcceptorIndex} = \Mu{x}
\ReceiveUnreliableL{\ProposerIndex}{\LOneA}{\mathbb{N}} .
\SendUnreliableL{\ProposerIndex}{\LOneB}{\Promise{\Value}} .\\
\Indent{1}\ReceiveWeaklyL{\ProposerIndex}{\Accept . \ReceiveUnreliableL{\ProposerIndex}{\LTwoA}{\Proposal{\Value}}.\End \oplus \Restart . x \oplus \Abort .\End}$

$\GlobalTypeProjection{\AcceptorIndex}$ defines the local type for acceptors, assuming a proposer $\ProposerIndex$.


\section{Type Check}
\subsection{System Initialization}
$\Gamma = \GEnvEntry{\OuterSharedPoint}{\OuterGlobalType} \cdot \GEnvEntry{\SharedPoint{ac+1}}{\GlobalType} \cdot \GEnvEntry{\SharedPoint{ac+2}}{\GlobalType} \cdot \ldots \cdot \GEnvEntry{\SharedPoint{ac+pc}}{\GlobalType}$.

\begin{prooftree}
\AxiomC{$\SysProof{1}$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{\OuterSharedPoint}{2}{t}\ldots \vartriangleright \emptyset$}

\AxiomC{$\SysProof{2}$}
\UnaryInfC{$\Gamma\vdash \SessionAccept{\OuterSharedPoint}{1}{t} \ldots \vartriangleright \emptyset$}

\AxiomC{$\SysProof{3}$}
\UnaryInfC{$\Gamma\vdash \ParallelFor{1 \leq \AcceptorIndex \leq ac} \PaInitShort \vartriangleright \emptyset$}

\RightLabel{$\RPar$}
\BinaryInfC{$\Gamma\vdash \SessionAccept{\OuterSharedPoint}{1}{t} \ldots \Or \ParallelFor{1 \leq \AcceptorIndex \leq ac} \PaInitShort \vartriangleright \emptyset$}

\RightLabel{$\RPar$}
\BinaryInfC{$\Gamma\vdash \SessionRequest{\OuterSharedPoint}{2}{t}.\PpInitShort \Or \SessionAccept{\OuterSharedPoint}{1}{t} \ldots \Or \ParallelFor{1 \leq \AcceptorIndex \leq ac} \PaInitShort \vartriangleright \emptyset$}
\end{prooftree}

\subsubsection{$\SysProof{1}$}
\begin{prooftree}
\AxiomC{$\ProposerProof{}$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{\SharedPoint{ac+pc}}{ac+1}{s}.\Pp{} \vartriangleright \SEnvEntry{t}{2}{\OuterGlobalTypeProjection{2}}$}

\LeftLabel{$\SysProof{1} =$}
\RightLabel{$\RRec$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{\OuterSharedPoint}{2}{t}.\PpInit{ac+1}{\genAq{ac+pc}{ac}{pc}}{ac+pc}{ac+pc}{[]} \vartriangleright \emptyset$}
\end{prooftree}

Since $\OuterGlobalTypeProjection{2} = \End$, $\SEnvEntry{t}{2}{\OuterGlobalTypeProjection{2}} = \emptyset$.
This is relevant later when continuing proof $\ProposerProof{}$.

\subsubsection{$\SysProof{2}$}
\begin{prooftree}
\AxiomC{$\ProposerProof{}$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{\SharedPoint{ac+1}}{ac+1}{s}.\Pp{} \vartriangleright \emptyset$}

\AxiomC{$\ldots$}

\AxiomC{$\ProposerProof{}$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{\SharedPoint{ac+pc-1}}{ac+1}{s}.\Pp{} \vartriangleright \emptyset$}

\RightLabel{$\RPar^{??}$}
\TrinaryInfC{$\Gamma\vdash \ParallelFor{ac < k < ac+pc} \PpInit{ac+1}{\genAq{k}{ac}{pc}}{k}{k}{[]} \vartriangleright \SEnvEntry{t}{1}{G\upharpoonright_1}$}

\LeftLabel{$\SysProof{2} =$}
\RightLabel{$\RAcc$}
\UnaryInfC{$\Gamma\vdash \SessionAccept{\OuterSharedPoint}{1}{t} . \ParallelFor{ac < k < ac+pc} \PpInitShort \vartriangleright \emptyset$}
\end{prooftree}

Because $\OuterGlobalTypeProjection{1} = \End$, $\SEnvEntry{t}{1}{\OuterGlobalTypeProjection{1}} = \emptyset$.
So $\Delta$ for each proposer is empty at this point.

\subsubsection{$\SysProof{3}$}
\begin{prooftree}
\AxiomC{$\AcceptorProof{}$}
\UnaryInfC{$\Gamma\vdash \PaOne \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\GlobalTypeProjection{j}}$}
\RightLabel{$\RAcc$}
\UnaryInfC{$\Gamma\vdash\SessionAccept{\SharedPoint{k}}{j}{s}.\PaOne\vartriangleright\emptyset$}
\AxiomC{$\ldots$}
\RightLabel{$\RPar^*$}
\BinaryInfC{$\Gamma\vdash\ParallelFor{ac < k \le ac + pc} \SessionAccept{\SharedPoint{k}}{ac}{s} . \PaOne\vartriangleright\emptyset$}
\AxiomC{$\ldots$}

\LeftLabel{$\SysProof{3} =$}
\RightLabel{$\RPar^*$}
\BinaryInfC{$\Gamma\vdash\ParallelFor{1 \leq \AcceptorIndex \leq ac} \left(\ParallelFor{ac < k \le ac + pc} \SessionAccept{\SharedPoint{k}}{\AcceptorIndex}{s} . \PaOne\right) \vartriangleright\emptyset$}
\end{prooftree}

\subsection{Proposer}
For simplicity, let $\ProposerIndex = ac + 1, \AQ = \genAq{y}{ac}{pc}, n = y, m = y, \VectorV = []$ where $ac < y \leq ac + pc$.
% From that we know that $\Gamma = \Gamma' \cdot i:\mathbb{N} \cdot n:\mathbb{N} \cdot m:\mathbb{N}$.
% so just the arguments for a proposer y.

$\TpAccept = \DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableL{\AcceptorIndex}{\LTwoA}{\Proposal{\Value}}}.\End$

$\TpBranch = \SendWeaklyL{\AQ}{\Accept . \TpAccept \oplus \Restart . x \oplus \Abort .\End}$

$e = \anyNack{\VectorV} \tOr \promiseCount{\VectorV} < \ceil{\frac{i}{2}}$

$pn = \proposalNumber{n}{m}$

$\Gamma'=\Gamma\cdot\GEnvEntry{X}{x}$

$\Gamma'' = \Gamma' \cdot \GEnvEntry{v_{\AcceptorIndex}}{\Promise{\Value}}$ for $\AcceptorIndex\in\AQ$

$prop = \ProposalC{\proposalNumber{n}{m}}{\promiseValue{\VectorV}}$

\subsubsection{$\ProposerProof{}$}
\begin{prooftree}
\AxiomC{$\ProposerProofTrue$}
\UnaryInfC{$\Gamma'' \vdash \SendWeaklyP{s}{\ProposerIndex}{\AQ}{\Restart}{X} \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\TpBranch}$}

\AxiomC{$\ProposerProofFalse$}
\UnaryInfC{$\Gamma'' \vdash \SendWeaklyP{s}{\ProposerIndex}{\AQ}{\Accept}{\ldots} \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\TpBranch}$}

\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma'' \vdash \If{e} \Then{\SendWeaklyP{s}{\ProposerIndex}{\AQ}{\Restart}{X}} \Else{\SendWeaklyP{s}{\ProposerIndex}{\AQ}{\Accept}{\ldots}} \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\TpBranch}$}

\RightLabel{$\RUget^{|\AQ|}$}
\UnaryInfC{$\Gamma' \vdash \DotForall{\AcceptorIndex\in\AQ}{\ReceiveUnreliableP{s}{\AcceptorIndex}{\ProposerIndex}{\LOneB}{\bot}{v_{\AcceptorIndex}}} \ldots \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\DotForall{\AcceptorIndex\in\AQ}{\ReceiveUnreliableL{\AcceptorIndex}{\LOneB}{\Promise{\Value}}}}$}

\RightLabel{$\RUsend^{|\AQ|}$}
\UnaryInfC{$\Gamma' \vdash \DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableP{s}{\ProposerIndex}{\AcceptorIndex}{\LOneA}{pn}} \ldots \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableL{\AcceptorIndex}{\LOneA}{\mathbb{N}}}\ldots}$}

\RightLabel{$?$}
\UnaryInfC{$\Gamma' \vdash \update{n}{n+1} \ldots \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableL{\AcceptorIndex}{\LOneA}{\mathbb{N}}}\ldots}$}

\RightLabel{$\RRec$}
\UnaryInfC{$\Gamma\vdash \Mu{X} \update{n}{n + 1} \ldots \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\Mu{x}\DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableL{\AcceptorIndex}{\LOneA}{\mathbb{N}}}\ldots}$}

\LeftLabel{$\ProposerProof{} =$}
\RightLabel{$\RReq$}
\UnaryInfC{$\Gamma\vdash \SessionRequest{\SharedPoint{n}}{\ProposerIndex}{s}.\Pp{} \vartriangleright \emptyset$}
\end{prooftree}

\subsubsection{$\ProposerProofTrue$}
\begin{prooftree}
\AxiomC{}
\RightLabel{$\RVar$}
\UnaryInfC{$\Gamma\vdash X \vartriangleright \SEnvEntry{s}{\ProposerIndex}{x}$}
\LeftLabel{$\ProposerProofTrue =$}
\RightLabel{$\RWsel$}
\UnaryInfC{$\Gamma\vdash \SendWeaklyP{s}{\ProposerIndex}{\AQ}{\Restart}{X} \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\SendWeaklyL{\AQ}{\Accept . \TpAccept \oplus \Restart . x \oplus \Abort .\End}}$}
\end{prooftree}

\subsubsection{$\ProposerProofFalse$}
\begin{prooftree}
\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma\vdash \End \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\End}$}
\UnaryInfC{$\Gamma\vdash \DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableP{s}{\ProposerIndex}{\AcceptorIndex}{\LTwoA}{prop}}.\End \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\DotForall{\AcceptorIndex\in\AQ}{\SendUnreliableL{\AcceptorIndex}{\LTwoA}{\Proposal{\Value}}}.\End}$}

\LeftLabel{$\ProposerProofFalse =$}
\RightLabel{$\RWsel$}
\UnaryInfC{$\Gamma\vdash \SendWeaklyP{s}{\ProposerIndex}{\AQ}{\Accept.\ldots} \vartriangleright \SEnvEntry{s}{\ProposerIndex}{\SendWeaklyL{\AQ}{\Accept . \TpAccept \oplus \Restart . x \oplus \Abort .\End}}$}
\end{prooftree}

\subsection{Acceptor}
$\Gamma'=\Gamma\cdot\GEnvEntry{X}{x}$

$i = ac + 1$

$\PaAccept = \ReceiveUnreliableP{s}{\ProposerIndex}{\AcceptorIndex}{\LTwoA}{\bot}{pr'} .
\If{pr' = \bot}\\
\Indent{1}\Then{\End}\\
\Indent{1}\Else{
    \If{\greaterEqual{\nFromProposal{pr'}}{n}}\\
    \Indent{2}\Then{\update{pr}{pr'} . \update{n}{\Just{\nFromProposal{pr'}}}.\End}\\
    \Indent{2}\Else{\End}}$

% TODO "Note that PaTwo = ... PaAccept"

$\Pa{t} = \update{n}{n'}.\SendUnreliableP{s}{\AcceptorIndex}{\ProposerIndex}{\LOneB}{\Promise{pr}}.\PaTwo$

$\Pa{f} = \SendUnreliableP{s}{\AcceptorIndex}{\ProposerIndex}{\LOneB}{\Nack{n}}.\PaTwo$

$\Pa{gt} = \If{\greaterThan{n'}{n}}\Then{\Pa{t}}\Else{\Pa{f}}$

% TODO "Not that PaOne = ... PaTwo ... Pagt"

$\TaAccept = \ReceiveUnreliableL{\ProposerIndex}{\LTwoA}{\Proposal{\Value}}.\End$

$\TaBranch = \ReceiveWeaklyL{\ProposerIndex}{\Accept . \TaAccept \oplus \Restart . x \oplus \Abort .\End}$

$\TaOneB = \SendUnreliableL{\ProposerIndex}{\LOneB}{\Promise{\Value}} . \TaBranch$

\subsubsection{$\AcceptorProof{}$}
\begin{prooftree}
\AxiomC{$\AcceptorProofCont$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaTwo \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaBranch}$}
\RightLabel{$\RUsend$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \SendUnreliableP{s}{\AcceptorIndex}{\ProposerIndex}{\LOneB}{\bot}.\PaTwo \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaOneB}$}

\AxiomC{$\AcceptorProof{gt}$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \Pa{gt} \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaOneB}$}

\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \If{n'=\bot}\Then{\PaTwo}\Else{\If{\greaterThan{n'}{n}}\ldots} \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaOneB}$}

\RightLabel{$\RUget$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x} \vdash \ReceiveUnreliableP{s}{\ProposerIndex}{\AcceptorIndex}{\LOneA}{\bot}{n'}.\If{n'=\bot}\ldots \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\ReceiveUnreliableL{\ProposerIndex}{\LOneA}{\mathbb{N}}.\TaOneB}$}

\LeftLabel{$\AcceptorProof{} =$}
\RightLabel{$\RRec$}
\UnaryInfC{$\Gamma\vdash \Mu{X} \ReceiveUnreliableP{s}{\ProposerIndex}{\AcceptorIndex}{\LOneA}{\bot}{n'}.\ldots \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\Mu{x}\ReceiveUnreliableL{\ProposerIndex}{\LOneA}{\mathbb{N}}.\ldots}$}
\end{prooftree}

\subsubsection{$\AcceptorProof{gt}$}
\begin{prooftree}
\AxiomC{$\AcceptorProofTrue$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \Pa{t} \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaOneB}$}

\AxiomC{$\AcceptorProofFalse$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \Pa{f} \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaOneB}$}

\LeftLabel{$\AcceptorProof{gt} =$}
\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \If{\greaterThan{n'}{n}}\Then{\Pa{t}}\Else{\Pa{f}} \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaOneB}$}
\end{prooftree}

\subsubsection{$\AcceptorProofTrue$}
\begin{prooftree}
\AxiomC{$\AcceptorProofCont$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaTwo \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaBranch}$}
\LeftLabel{$\AcceptorProofTrue =$}
\RightLabel{$\RUsend$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \SendUnreliableP{s}{\AcceptorIndex}{\ProposerIndex}{\LOneB}{\Nack{n}}.\PaTwo \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\SendUnreliableL{\ProposerIndex}{\LOneB}{\Promise{\Value}} . \TaBranch}$}
\end{prooftree}

\subsubsection{$\AcceptorProofFalse$}
\begin{prooftree}
\AxiomC{$\AcceptorProofCont$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaTwo \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaBranch}$}
\LeftLabel{$\AcceptorProofFalse =$}
\RightLabel{$\RUsend$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \SendUnreliableP{s}{\AcceptorIndex}{\ProposerIndex}{\LOneB}{\Nack{n}}.\PaTwo \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\SendUnreliableL{\ProposerIndex}{\LOneB}{\Promise{\Value}}.\TaBranch}$}
\end{prooftree}

\subsubsection{$\AcceptorProofCont$}
\begin{prooftree}
\AxiomC{$\AcceptorProofAccept$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaAccept \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaAccept}$}

\AxiomC{}
\RightLabel{$\RVar$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash X \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{x}$}

\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \End \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}

\LeftLabel{$\AcceptorProofCont =$}
\RightLabel{$\RWbran$}
\TrinaryInfC{$\Gamma\cdot\GEnvEntry{X}{x}\vdash \PaTwo \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\TaBranch}$}
\end{prooftree}

\subsubsection{$\AcceptorProofAccept$}
\begin{prooftree}
\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma'\vdash \End \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}

\AxiomC{$\AcceptorProof{update}$}
\UnaryInfC{$\Gamma'\vdash\update{pr}{pr'}.\ldots \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}

\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma'\vdash \End \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}

\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma'\vdash \If{\greaterEqual{\nFromProposal{pr'}}{n}}\Then{\ldots}\Else{\End} \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}

\RightLabel{$\RIf$}
\BinaryInfC{$\Gamma'\vdash \If{pr'=\bot}\Then{\End}\Else{\ldots} \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}
\LeftLabel{$\AcceptorProofAccept =$}
\RightLabel{$\RUget$}
\UnaryInfC{$\Gamma'\vdash \ReceiveUnreliableP{s}{\ProposerIndex}{\AcceptorIndex}{\LTwoA}{\bot}{pr'}.\ldots \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\ReceiveUnreliableL{\ProposerIndex}{\LTwoA}{\Proposal{\Value}}.\End}$}
\end{prooftree}

\subsubsection{$\AcceptorProof{update}$}
\begin{prooftree}
\AxiomC{}
\RightLabel{$\REnd$}
\UnaryInfC{$\Gamma'\vdash \End \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}
\RightLabel{$??$}
\UnaryInfC{$\Gamma'\vdash \update{n}{\Just{\nFromProposal{pr'}}}.\End \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}
\LeftLabel{$\AcceptorProof{update} =$}
\RightLabel{$??$}
\UnaryInfC{$\Gamma'\vdash\update{pr}{pr'}.\ldots \vartriangleright \SEnvEntry{s}{\AcceptorIndex}{\End}$}
\end{prooftree}
