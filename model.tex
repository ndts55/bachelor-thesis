\chapter{Model}
First, we specify some sorts with which we can then define the global type.
Afterwards, we define the processes for the proposer and the acceptor.
Finally, we will study an example run of the model.

\section{Sorts}
Sorts are basic data types.
We assume the following sorts.

First, we have $\Bool$ which we define as a set.

$\Bool = \Curly{\True, \False}$

Second, we assume a set of values $\Value$.

Then, we have some sorts which we define using a grammar.
% explain type variable a
Each of these definitions contains a type variable, which is a variable ranging over types.
In this case the type variable in each definition is called $a$.

% give some examples of values for each sort
$\Maybe{a} = \Just{a} \Or \Nothing$

A value of type $\Maybe{a}$ can have the form $\Just{a}$ or $\Nothing$.
Some examples include $\Just{4}$ of type $\Maybe{\mathbb{N}}$, $\Just{\False}$ of type $\Maybe{\Bool}$, and $\Nothing$.
$\Nothing$ itself does not dictate an exact type because its definition does not include the type variable $a$.
The type is underspecified and is specified manually or through the context in which $\Nothing$ is used.
It can be of type $\Maybe{\mathbb{N}}$, $\Maybe{\Bool}$, or any other type $b$ in $\Maybe{b}$.
We use $\Maybe{a}$ where optional values are needed.

$\Proposal{a} = \ProposalC{\mathbb{N}}{a}$

$\Proposal{a}$ only has one possible form, which is $\ProposalC{\mathbb{N}}{a}$.
A proposal contains its proposal number of type $\mathbb{N}$ and its value of type $a$.
Again, $a$ is a variable ranging over types.
An example for a value of type $\Proposal{\Bool}$ could be $\ProposalC{1}{\True}$ and an example for a value of type $\Proposal{\Maybe{\mathbb{N}}}$ could be $\ProposalC{1}{\Just{1}}$.
Note that $\ProposalC{1}{\Just{1}}$ is of type $\Proposal{a}$ where $a = \Maybe{b}$ and $b = \mathbb{N}$.
This sort models the proposals issued by the proposers in phase $2a$.

$\Promise{a} = \Promise{\Maybe{\Proposal{a}}} \Or \Nack{\mathbb{N}}$

$\Promise{a}$ has two possible forms.
$\Promise{\Maybe{\Proposal{a}}}$ and $\Nack{\mathbb{N}}$.
Note that $\Promise{\Maybe{\Proposal{a}}}$ is the same as $\Promise{c}$ where $c = \Maybe{b}$ and $b = \Proposal{a}$.
Possible values include $\Nack{1}$ and $\Promise{\Just{\ProposalC{1}{{-1}}}}$ of type $\Promise{\mathbb{Z}}$.
The actual type of $\Nack{1}$, much like that of $\Nothing$, is underspecified.
Again, we have to specify the exact type manually or through context.

In phase $1b$ the acceptors respond to the proposers prepare request with a value of type $\Promise{\Value}$.
The prepare request contains a number $n$.
The acceptors may respond to the prepare request with a promise to not accept any proposal numbered less than $n$ or with a rejection.
In the first case the acceptor's response optionally includes the last proposal it accepted, if available, and is of the form $\Promise{\Maybe{\Proposal{a}}}$.
In the second case it includes the highest $n$ that acceptor promised and is of the form $\Nack{\mathbb{N}}$.

\section{Global Type}
Since each proposer initiates its own session the global type can be defined for one proposer.
A quorum of acceptors $A_Q$ is assumed.

The last phase of Paxos contains no inter-process communication, so it is not modeled in the global type.

$G_{p, A_Q} = \Mu{X}
\Paren{\DotForall{a \in A_Q} \SendUnreliableG{p}{a}{l1a}{\mathbb{N}}} .
\Paren{\DotForall{a \in A_Q} \SendUnreliableG{a}{p}{l1b}{\Promise{\Value}}} .\\
\hspace*{0.5em}\SendWeaklyG{p}{A_Q}{\\
\hspace*{1em}
\Accept.\Paren{\DotForall{a \in A_Q} \SendUnreliableG{p}{a}{l2a}{\Proposal{\Value}}}.end \oplus
\Restart.X \oplus
\Abort.end}$

We can distinguish the individual phases of the Paxos algorithm by the labels $l1a$, $l1b$, and $l2a$.

In the first two steps, $1a$ and $1b$, the proposer sends its proposal number to each acceptor in $A_Q$ and listens for their responses.
In step 2a the proposer decides whether to send an $\Accept$ or $\Restart$ message to restart the algorithm.
This decision is broadcast to all acceptors in $A_Q$.
Should the proposer crash the algorithm ends for this particular proposer and quorum of acceptors.

\section{Functions}
We define some functions which we use in the next section to define the processes.

$\operatorname{proposalNumber} : \mathbb{N} \times \mathbb{N} \to \mathbb{N}$

$\proposalNumber{n}{p}$ returns a proposal number for proposer $p$ when given a natural number $n$.
We have two requirements for this function.

Let $\mathbb{P}$ be the set of proposers.

\[\forall p,q \in \mathbb{P} \; \forall n,m \in \mathbb{N}: p \neq q \to \proposalNumber{n}{p} \neq \proposalNumber{m}{q}\]

Different proposers pick their proposal numbers from disjoint sets of numbers.
This way different proposers never issue a proposal with the same proposal number.

\[\forall p \in \mathbb{P} \; \forall n,m \in \mathbb{N}: n > m \to \proposalNumber{n}{p} > \proposalNumber{m}{p}\]

We require $\proposalNumber{n}{p}$ to be strictly increasing for each proposer $p$ so every proposer uses a higher proposal number than any it has already used.

% Requirements:
%  Different proposers choose their numbers from disjoint sets of numbers, so two different proposers never issue a proposal with the same number. 
% Each proposer remembers (in stable storage) the highest-numbered proposal it has tried to issue, and begins phase 1 with a higher proposal number than any it has already used.

$\operatorname{promiseValue} : \List{\Promise{a}} \to a$

$\promValue{ps}$ returns a fresh value if none of the promises in $ps$ contain a value. Otherwise, the best value is returned. Usually, that means the value with the highest associated proposal number.
A promise contains a value $v$ if it is of the form $\Promise{(\Just{v})}$.

$\operatorname{anyNack} : \List{\Promise{a}} \to \Bool\\
\anyNack{\EmptyList} = \False\\
\anyNack{\ListPattern{\Nack{\Wildcard}}{\Wildcard}} = \True\\
\anyNack{\ListPattern{\Wildcard}{xs}} = \anyNack{xs}$

$\anyNack{ps}$ returns $\True$ if the list contains at least one promise of the form $\Nack{n}$.
Otherwise, it returns $\False$.

$\operatorname{promiseCount} : \List{\Promise{a}} \to \mathbb{N}\\
\promiseCount{\EmptyList} = 0\\
\promiseCount{\ListPattern{\Promise{\Wildcard}}{xs}} = 1 + \promiseCount{xs}\\
\promiseCount{\ListPattern{\Wildcard}{xs}} = \promiseCount{xs}$

$\promiseCount{ps}$ takes a list of promises $ps$ and calculates the number of promises in that list of that have the form $\Promise{m}$.

$\operatorname{gt}: a \to \Maybe{a} \to \Bool\\
\greaterThan{\Wildcard}{\Nothing} = \True\\
\greaterThan{a}{\Just{b}} = a > b$

$\operatorname{ge}: a \to \Maybe{a} \to \Bool\\
\greaterEqual{\Wildcard}{\Nothing} = \True\\
\greaterEqual{a}{\Just{b}} = a \ge b$

$\operatorname{nFromProposal} : \Proposal{a} \to \mathbb{N}\\
\nFromProposal{\ProposalC{n}{\Wildcard}} = n$

$\nFromProposal{p}$ retrieves the proposal number $n$ inside proposal $p$, which has the form $\ProposalC{n}{pr}$.

$\operatorname{genA_Q} : \mathbb{N} \times \mathbb{N} \times \mathbb{N} \to \mathbb{N}$

$\genAq{i}{ac}{pc}$ returns a randomly selected set $A_Q$ with $A_Q \subseteq A = \Curly{1, \dots, ac}$ and $|A_Q| > \frac{|A|}{2}$.
$A_Q$ consists of any majority of acceptors.
In Paxos a majority of acceptors forms a quorum, i.e. an accepting set with which a value can be chosen \cite{lower_bounds}.

\section{Processes}
\subsection{System Initialization}
% Idea: One shared-point per Proposer over which the session is initialized.
$\Sys{ac}{pc} = \SessionRequest{a}{2}{t} . \PpInit{ac + 1}{\genAq{ac + pc}{ac}{pc}}{ac + pc}{ac + pc}{[]}\\
\Or \SessionAccept{a}{1}{t} . \ParallelFor{ac < i < ac + pc} \PpInit{ac + 1}{\genAq{i}{ac}{pc}}{i}{i}{[]} \\
\Or \ParallelFor{1 \le j \le ac} \PaInit{j}{ac + 1}{ac}{pc}{n_j}{pr_j}$

$\PpInit{i}{A_Q}{n}{m}{\VectorV} = \SessionRequest{b_n}{i}{s} . \Pp$

$\PaInit{j}{i}{ac}{pc}{n}{pr} = \ParallelFor{ac < k \le ac + pc} \SessionAccept{b_k}{j}{s} . \Pa$

$\Sys{ac}{pc}$, $\PpInit{i}{A_Q}{n}{m}{\VectorV}$, and $\PaInit{j}{i}{ac}{pc}{n}{pr}$ describe the system initialization.
$ac$ and $pc$ are the number of acceptors and proposers respectively.

An outer session is created through shared-point $a$.
This outer session is not strictly necessary but was left in to allow for easier extension of the model.
The acceptors are initialized using indices from 1 to $ac$ and the proposers are initialized using indices from $ac + 1$ to $ac + pc$.

$\PpInit{i}{A_Q}{n}{m}{\VectorV}$ is initialized with the proposer's role in its own session $i$, which is always $ac + 1$, a quorum of acceptors $A_Q$, an index $n$, and a vector $\VectorV$.
Each proposer has the same role $i = ac + 1$ but uses a different shared-point $b_n$ according to its index $n$.
$\VectorV$ is used in the proposer to collect and evaluate the responses from the acceptors.
It is always initialized with an empty list $[]$.
Shared-point $b_n$ is used to initiate a session.
Afterwards, the process behaves like $\Pp$.

$\PaInit{j}{i}{ac}{pc}{n}{pr}$ is initialized with the acceptor's index $j$, the proposer index $i$, which is always $ac + 1$, $ac$, $pc$, initial knowledge for the highest promised proposal number $n$, if available, and initial knowledge for the most recently accepted proposal $pr$, if available.
$n$ is of type $\Maybe{\mathbb{N}}$ and $pr$ is of type $\Maybe{\Paren{\Proposal{\Value}}}$ thus both can be $\Nothing$.
Each of the proposers' session requests are accepted in a separate subprocess.
These subprocesses run parallel to each other but still access the same values for $n$ and $pr$.
We observe that each subprocess in an acceptor accesses a different channel $s$, since it is generated by the proposer and passed through when the proposers' session request is accepted.
Afterwards, each subprocess behaves like $\Pa$.

\subsection{Proposer}
To define the proposer and the acceptor we introduce a function $\update{n}{m}$ which replaces the value inside $n$ with the value of $m$.
We use this function to update the local variables of the processes.

$\Pp = \Mu{X} \update{n}{n + 1} .\\
\hspace*{0.5em}\left(\DotForall{j \in A_Q} \SendUnreliableP{s}{i}{j}{l1a}{\proposalNumber{n}{m}}\right) .\\
\hspace*{0.5em}\left(\DotForall{j \in A_Q} \ReceiveUnreliableP{s}{j}{i}{l1b}{\perp}{v_j}\right) .\\
\hspace*{0.5em}\If{\anyNack{\VectorV} \tOr \promiseCount{\VectorV} < \ceil{\frac{i}{2}}}\\
\hspace*{1em}\Then{\SendWeaklyP{s}{i}{A_Q}{\Restart}{X}}\\
\hspace*{1em}\Else{\\\hspace*{1.5em}\SendWeaklyP{s}{i}{A_Q}{\Accept}{\\\hspace*{1.5em}\DotForall{j \in A_Q} \SendUnreliableP{s}{i}{j}{l2a}{\ProposalC{\proposalNumber{n}{m}}{\promValue{\VectorV}}}.\\\hspace*{1.5em}end}}$

At the start of the recursion $n$ is incremented to make sure every run of the recursion uses a different $n$ and thus a different proposal number.
The proposal number is sent to every acceptor in $A_Q$ and their replies are gathered in $\VectorV$ through $v_j$.
Because $i = ac + 1$, the minimum number of acceptors needed to form a majority is $\ceil{\frac{i}{2}} = \ceil{\frac{ac + 1}{2}}$.
If any $\Nack{x}$ was received or the number of $\Promise{y}$ received is less than that needed for the smallest majority the proposer restarts the algorithm.
Otherwise, the proposer sends its proposal to the acceptors and terminates.

\subsection{Acceptor}
$\Pa = \Mu{X} \ReceiveUnreliableP{s}{i}{j}{l1a}{\perp}{n'} .\\
\hspace*{0.5em}\If{n' = \perp}\\
\hspace*{1em}\Then{\PaCont}\\
\hspace*{1em}\Else{\\
\hspace*{1.5em}\If{\greaterThan{n'}{n}}\\
\hspace*{1.5em}\Then{\update{n}{n'}.\SendUnreliableP{s}{j}{i}{l1b}{\Promise{pr}}.\PaCont}\\
\hspace*{1.5em}\Else{\SendUnreliableP{s}{j}{i}{l1b}{\Nack{n}}.\PaCont}}$

$\PaCont = \ReceiveWeaklyP{s}{i}{j}{\Accept . \ReceiveUnreliableP{s}{i}{j}{l2a}{\perp}{pr'} .\\
\hspace*{1em}\If{pr' = \perp}\\
\hspace*{1.5em}\Then{end}\\
\hspace*{1.5em}\Else{\\
\hspace*{2em}\If{\greaterEqual{\nFromProposal{pr'}}{n}}\\
\hspace*{2.5em}\Then{\update{pr}{pr'} . \update{n}{\Just{\nFromProposal{pr'}}}.end}\\
\hspace*{2.5em}\Else{end}}\\
\hspace*{0.5em} \oplus \Restart.X\\
\hspace*{0.5em} \oplus \Abort.end}$

For each proposer an acceptor has a corresponding subprocess, which behaves like $\Pa$.
These subprocesses access the same values for $n$ and $pr$.
This means that updating these values with $\update{n}{m}$ updates them for all subprocesses of an acceptor.

Each subprocess can communicate with one proposer.
Thus, if that proposer does not or can not communicate with a particular subprocess of an acceptor then there is no need for that subprocess.
It is possible that an acceptor participates in a proposers' session but is not contained in the proposers' quorum of acceptors $A_Q$, in which case the proposer does not communicate with that acceptor.
It is also possible for a proposer to crash or otherwise terminate, in which case the proposer can not communicate with that acceptor.

Each subprocess starts out by potentially receiving a proposal number $n'$ from the corresponding proposer.
If the acceptor does receive a proposal number $n'$ it responds with either $\Promise{pr}$ or $\Nack{n}$, depending on the values of $n'$ and $n$.
If the acceptor does not receive a proposal number then it sends no response to the proposer.
In either case the subprocess moves on to receive the proposers' decision in phase $2a$.
% why does the acceptor move on if it received no proposal number?

% Abort -> end
Since the proposers' decision broadcast is weakly reliable, there are two cases in which the acceptor receives no decision.
The proposer might have terminated or this particular acceptor is not in the proposers' quorum of acceptors $A_Q$.
In either case this particular subprocess of the acceptor is no longer needed, because each subprocess of the acceptor exclusively communicates with one proposer.
Thus, the subprocess terminates in the default branch $\Abort$.

% Restart -> recurse
In the $\Restart$ branch this particular subprocess of the acceptor restarts the algorithm to match the corresponding proposer.

% Accept -> receive pr', update, end because proposer ends
In the $\Accept$ branch the acceptor potentially receives a proposal $pr'$ from the corresponding proposer.
The acceptor updates $n$ and $pr$ if the proposal number in $pr'$ is greater or equal to $n$.
Then the subprocess terminates.
If the acceptor does not receive a proposal or the proposal number of $pr'$ is less than $n$ the subprocess terminates without updating $n$ or $pr$.

\section{Failure Patterns}
Chandra and Toueg introduce a class of failure detectors $\EventuallyWeak$, which is called \emph{eventually weak} in \cite{failure_detectors}.
Failure detectors in $\EventuallyWeak$ satisfy the following properties: (1) eventually every process that crashes is permanently suspected by some correct process and (2) eventually some correct process is never suspected by any correct process.

In all three phases modeled in the global type it is possible to suspect senders.
In phases $1a$ and $2a$, with labels $l1a$ and $l2a$ respectively, the acceptors may suspect some proposers.
The proposers may suspect some acceptors in phase $1b$ with label $l1b$.
Accordingly, $\FPuskip$ is implemented with a failure detector in $\EventuallyWeak$ for phases $1a$, $1b$, and $2a$.

Similarly, message loss is possible in all phases modeled in the global type.
Thus, $\FPml$ is also implemented with a failure detector in $\EventuallyWeak$.

For the weakly reliable broadcast in phase $2a$, the failure pattern $\FPwskip$ returns $\True$ if, and only if, the corresponding proposer crashed or otherwise terminated.

For Paxos to work a majority of acceptors needs to be alive.
That means that the number of failed acceptors $f$ needs to satisfy $n > 2f$ where $n$ is the total number of acceptors, except in one case where there are 2 acceptors.
Then, at most one acceptor may crash \cite{lower_bounds}.
$\FPcrash$ returns $\True$ if, and only if, at least one more acceptor may crash, i.e. $n > 2(f + 1)$ is satisfied.

In Paxos there is no need to reject outdated messages so $\FPuget$ is implemented with a constant $\True$.


\section{Example}
In this section we will study an example run of the model with $3$ acceptors and $2$ proposers.
First, we will take a look at the example scenario.
Then we will examine the scenario using reduction rules starting at system initialization.

\begin{figure}
\begin{tikzpicture}[node distance=2cm, >=stealth', arrt/.style={above, font=\footnotesize}, arr/.style={->, thick}]
    \def\InitialOffset{0.4}
    \def\StepSize{0.7}
    \newcommand{\Step}[1]{\InitialOffset + #1 * \StepSize}
    \def\MaxSteps{14}
    \def\FullHeight{\Step{\MaxSteps} + 0.66 * \StepSize}

    \node (a1) {$\Acceptor{1}$};
    \node[right = of a1] (a2) {$\Acceptor{2}$};
    \node[right = of a2] (a3) {$\Acceptor{3}$};
    \node[right = of a3] (p4) {$\Proposer{4}$};
    \node[right = of p4] (p5) {$\Proposer{5}$};
    \node[left = of a1] (notes) {};

    \draw[dashed] (a1) -- ($(a1) - (0, \FullHeight)$);
    \draw[dashed] (a2) -- ($(a2) - (0, \FullHeight)$);
    \draw[dashed] (a3) -- ($(a3) - (0, \FullHeight)$);
    \draw[dashed] (p4) -- ($(p4) - (0, \Step{14.5})$);
    \draw[dashed] (p5) -- ($(p5) - (0, \Step{5.5})$);
    
    \draw[arr] ($(p5) - (0, \Step{1})$) -- node[arrt] {$\proposalNumber{6}{5} = 10$} ($(a2) - (0, \Step{1})$);
    \draw[arr] ($(p5) - (0, \Step{1})$) -- ($(a3) - (0, \Step{1})$);

    \draw[arr] ($(a2) - (0, \Step{2})$) -- node[arrt] {$\Promise{\Nothing}$} ($(p5) - (0, \Step{2})$);

    \draw[arr] ($(a3) - (0, \Step{3})$) -- node[arrt] {$\Promise{\Nothing}$} ($(p5) - (0, \Step{3})$);

    \draw[arr] ($(p5) - (0, \Step{4})$) -- node[arrt] {$\Accept$} ($(a2) - (0, \Step{4})$);
    \draw[arr] ($(p5) - (0, \Step{4})$) -- ($(a3) - (0, \Step{4})$);

    \draw[arr] ($(p5) - (0, \Step{5})$) -- node[arrt] {$\ProposalC{10}{\ABC}$} ($(a2) - (0, \Step{5})$);
    \draw[arr] ($(p5) - (0, \Step{5})$) -- ($(a3) - (0, \Step{5})$);

    \draw[arr] ($(p4) - (0, \Step{6})$) -- node[arrt] {$\proposalNumber{5}{4} = 5$} ($(a1) - (0, \Step{6})$);
    \draw[arr] ($(p4) - (0, \Step{6})$) -- ($(a2) - (0, \Step{6})$);

    \draw[arr] ($(a1) - (0, \Step{7})$) -- node[arrt] {$\Promise{\Nothing}$} ($(p4) - (0, \Step{7})$);

    \draw[arr] ($(a2) - (0, \Step{8})$) -- node[arrt] {$\Nack{10}$} ($(p4) - (0, \Step{8})$);

    \draw[arr] ($(p4) - (0, \Step{9})$) -- node[arrt] {$\Restart$} ($(a1) - (0, \Step{9})$);
    \draw[arr] ($(p4) - (0, \Step{9})$) -- ($(a2) - (0, \Step{9})$);

    \draw[arr] ($(p4) - (0, \Step{10})$) -- node[arrt] {$\proposalNumber{6}{4} = 15$} ($(a1) - (0, \Step{10})$);
    \draw[arr] ($(p4) - (0, \Step{10})$) -- ($(a2) - (0, \Step{10})$);

    \draw[arr] ($(a1) - (0, \Step{11})$) -- node[arrt] {$\Promise{\Nothing}$} ($(p4) - (0, \Step{11})$);
    
    \draw[arr] ($(a2) - (0, \Step{12})$) -- node[arrt] {$\Promise{\ProposalC{10}{\ABC}}$} ($(p4) - (0, \Step{12})$);

    \draw[arr] ($(p4) - (0, \Step{13})$) -- node[arrt] {$\Accept$} ($(a1) - (0, \Step{13})$);
    \draw[arr] ($(p4) - (0, \Step{13})$) -- ($(a2) - (0, \Step{13})$);

    \draw[arr] ($(p4) - (0, \Step{14})$) -- node[arrt] {$\ProposalC{15}{\ABC}$} ($(a1) - (0, \Step{14})$);
    \draw[arr] ($(p4) - (0, \Step{14})$) -- ($(a2) - (0, \Step{14})$);

    \foreach \r in {1,...,\MaxSteps} {
        \node[font=\footnotesize] at ($(notes) - (0, \Step{\r})$) {$(\r)$};
    }
\end{tikzpicture}
\caption{Example scenario with $3$ acceptors and $2$ proposers.}
\label{fig:scenario}
\end{figure}

\subsection{Scenario}
Figure \ref{fig:scenario} provides an overview where $\Acceptor{1}$, $\Acceptor{2}$, and $\Acceptor{3}$ are the acceptors and $\Proposer{4}$ and $\Proposer{5}$ are the proposers.
In steps $\Paren{1}$ to $\Paren{5}$, $\Proposer{5}$ completes the Paxos algorithm with $\Acceptor{2}$ and $\Acceptor{3}$ and terminates.

At this point $\Acceptor{2}$ has promised not to accept any proposal numbered less than $10$ and has accepted the value $\ABC$.
So, when $\Proposer{4}$ tries to use $4$ as its proposal number $\Paren{6}$, it receives $\Nack{10}$ from $\Acceptor{2}$ $\Paren{8}$ and has to restart the algorithm $\Paren{9}$.

$\Proposer{4}$ then runs through the Paxos algorithm with $\Acceptor{1}$ and $\Acceptor{2}$ starting with a new prepare request $\Paren{10}$ with a higher proposal number.
In step $\Paren{12}$ $\Proposer{4}$ learns that value $\ABC$ with proposal number $10$ has already been accepted by $\Acceptor{2}$.
Later, in step $\Paren{14}$, $\Proposer{4}$ issues a proposal with the value of the highest-numbered proposal that it receives as a response to its prepare request.
In this case there is only one such proposal, which is $\ProposalC{10}{\ABC}$.

In the end all $3$ acceptors have accepted the value $\ABC$.
$\Acceptor{1}$ and $\Acceptor{2}$ have accepted $\ProposalC{15}{\ABC}$ and $\Acceptor{3}$ has accepted $\ProposalC{10}{\ABC}$.

\subsection{Formulae}
We set $ac = 3$, $pc = 2$, and $V=\Curly{\ABC, \operatorname{def}, \dots, \operatorname{vwx}, \operatorname{yz}}$.

\subsubsection{System Initialization}
After inserting $ac$ and $pc$ and applying $\Init$ once we have:

$\Sys{ac}{pc} = \Sys{3}{2} =
\SessionAccept{a}{1}{t}.\ParallelFor{3 < i < 5} \PpInit{4}{\genAq{i}{3}{2}}{i}{i}{[]}\\
\Or \SessionRequest{a}{2}{t}.\PpInit{4}{\genAq{5}{3}{2}}{5}{5}{[]}\\
\Or \ParallelFor{1 \le j \le 3} \PaInit{j}{4}{3}{2}{n_j}{pr_j}$

% $\mapstostar \Init\\
% \Nu{t}\big (
% \PpInit{4}{A_{Q,1}}{4}{4}{[]} \Or \PpInit{4}{A_{Q,2}}{5}{5}{[]}\\
% \Or \PaInit{1}{4}{3}{2}{n_1}{pr_1} \Or \PaInit{2}{4}{3}{2}{n_2}{pr_2} \Or \PaInit{3}{4}{3}{2}{n_3}{pr_3}\\
% \Or \OuterSessionQueues
% \big )$

% $=\\
% % Is this step really necessary?
% \Nu{t}\big (
% \SessionRequest{b_4}{4}{s}.\Pp \Or \SessionRequest{b_5}{4}{r}.\Pp\\
% \Or \ParallelFor{3 < n \le 5} \SessionAccept{b_n}{1}{s} . \Pa\\
% \Or \ParallelFor{3 < n \le 5} \SessionAccept{b_n}{2}{s} . \Pa\\
% \Or \ParallelFor{3 < n \le 5} \SessionAccept{b_n}{3}{s} . \Pa\\
% \Or \OuterSessionQueues
% \big )$

$\mapstostar
\Nu{t}\big (
\SessionRequest{b_4}{4}{s}.\Pp \comment{= \Proposer{4}}\\
\Or \SessionRequest{b_5}{4}{r}.\Pp \comment{= \Proposer{5}}\\
\Or \Paren{\SessionAccept{b_4}{1}{s}.\Pa \Or \SessionAccept{b_5}{1}{r}.\Pa} \comment{= \Acceptor{1}}\\
\Or \Paren{\SessionAccept{b_4}{2}{s}.\Pa \Or \SessionAccept{b_5}{2}{r}.\Pa} \comment{= \Acceptor{2}}\\
\Or \Paren{\SessionAccept{b_4}{3}{s}.\Pa \Or \SessionAccept{b_5}{3}{r}.\Pa} \comment{= \Acceptor{3}}\\
\Or \OuterSessionQueues
\big )$

We apply $\Init$ thrice for shared-point $b_4$ and thrice again for shared-point $b_5$ to obtain:

$\mapstostar
\NuChannels\big (\\
\Mu{X} \update{n}{5} . \Paren{\DotForall{j\in \{1,2\}} \SendUnreliableP{s}{4}{j}{l1a}{\proposalNumber{n}{4}}}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \update{n}{6} . \Paren{\DotForall{j\in \{2,3\}} \SendUnreliableP{r}{4}{j}{l1a}{\proposalNumber{n}{5}}}\dots \comment{= \Proposer{5}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \ReceiveUnreliableP{r}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
} \comment{= \Acceptor{1}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \ReceiveUnreliableP{r}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
} \comment{= \Acceptor{2}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \ReceiveUnreliableP{r}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
} \comment{= \Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

% $=\\
% \NuChannels\big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \SendUnreliableP{r}{4}{2}{l1a}{\proposalNumber{6}{5}}.\SendUnreliableP{r}{4}{3}{l1a}{\proposalNumber{6}{5}}\dots\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveUnreliableP{r}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveUnreliableP{r}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveUnreliableP{r}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

Note that each process is shortened to only show the next few steps instead of the entire process.

\subsubsection{The Happy Path}
After applying the updates in $\Proposer{4}$ and $\Proposer{5}$ the first inter-process communication can take place.
In this case $\Proposer{5}$ communicates with $\Acceptor{2}$ and $\Acceptor{3}$.
We apply $\Usend$ and $\Uget$ twice to send $\proposalNumber{6}{5} = 10$ to $\Acceptor{2}$ and $\Acceptor{3}$.
% corresponds to (1)

$\mapstostar
\NuChannels \big (\\
\Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \ReceiveUnreliableP{r}{2}{4}{l1b}{\perp}{v_2}.\ReceiveUnreliableP{r}{3}{4}{l1b}{\perp}{v_3}\dots \comment{= \Proposer{5}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \ReceiveUnreliableP{r}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
} \comment{=\Acceptor{1}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \If{10 = \perp} \Then{\PaCont} \Else{\dots}
} \comment{=\Acceptor{2}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \If{10 = \perp} \Then{\PaCont} \Else{\dots}
} \comment{=\Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

Since $10 \neq \perp$ both $\Acceptor{2}$ and $\Acceptor{3}$ move into their respective $\Else$ branches.

$=
\NuChannels \big (\\
\Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \ReceiveUnreliableP{r}{2}{4}{l1b}{\perp}{v_2}.\ReceiveUnreliableP{r}{3}{4}{l1b}{\perp}{v_3}\dots \comment{= \Proposer{5}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \ReceiveUnreliableP{r}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
} \comment{=\Acceptor{1}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \If{\greaterThan{10}{\Nothing}} \Then{\dots} \Else{\dots}
} \comment{=\Acceptor{2}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \If{\greaterThan{10}{\Nothing}} \Then{\dots} \Else{\dots}
} \comment{=\Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

% % A1: n=Nothing, pr=Nothing
% % A2: n=10, pr=Nothing
% % A3: n=Nothing, pr=Nothing
% $=\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \SendUnreliableP{r}{4}{3}{l1a}{\proposalNumber{6}{5}}.\ReceiveUnreliableP{r}{2}{4}{l1b}{\perp}{v_2}\dots\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveUnreliableP{r}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \SendUnreliableP{r}{2}{4}{l1b}{\Promise{\Nothing}}.\PaCont
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveUnreliableP{r}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

Because $\greaterThan{10}{\Nothing}$ returns $\True$, $\Acceptor{2}$ and $\Acceptor{3}$ move into their respective $\Then$ branches.
After executing $\update{n}{10}$, $\Acceptor{2}$ and $\Acceptor{3}$ are ready to send their responses to $\Proposer{5}$.

% A1: n=Nothing, pr=Nothing
% A2: n=10, pr=Nothing
% A3: n=10, pr=Nothing
$=
\NuChannels \big (\\
\Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \ReceiveUnreliableP{r}{2}{4}{l1b}{\perp}{v_2}.\ReceiveUnreliableP{r}{3}{4}{l1b}{\perp}{v_3}\dots \comment{= \Proposer{5}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \ReceiveUnreliableP{r}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
} \comment{= \Acceptor{1}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \SendUnreliableP{r}{2}{4}{l1b}{\Promise{\Nothing}}.\PaCont
} \comment{= \Acceptor{2}}\\
\Or \Paren{
    \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
    \Or \Mu{X} \SendUnreliableP{r}{3}{4}{l1b}{\Promise{\Nothing}}.\PaCont
} \comment{= \Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

We apply $\Usend$ and $\Uget$ twice to do just that.
Note that we also apply $\Uskip$ to $\Acceptor{1}$ and evaluate its branches.
All three acceptors move into $\PaCont$.
% corresponds to (2) - (3)

% $\mapstostar (USkip)\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \ReceiveUnreliableP{r}{2}{4}{l1b}{\perp}{v_2}.\ReceiveUnreliableP{r}{3}{4}{l1b}{\perp}{v_3}\dots\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \If{\perp = \perp} \Then{\PaCont} \Else{\dots}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \SendUnreliableP{r}{2}{4}{l1b}{\Promise{\Nothing}}.\PaCont
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \SendUnreliableP{r}{3}{4}{l1b}{\Promise{\Nothing}}.\PaCont
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% $=\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \ReceiveUnreliableP{r}{2}{4}{l1b}{\perp}{v_2}.\ReceiveUnreliableP{r}{3}{4}{l1b}{\perp}{v_3}\dots\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveWeaklyP{r}{4}{1}{\Accept \dots \oplus \Restart .X \oplus \Abort .end}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \SendUnreliableP{r}{2}{4}{l1b}{\Promise{\Nothing}}.\PaCont
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \SendUnreliableP{r}{3}{4}{l1b}{\Promise{\Nothing}}.\PaCont
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% $\mapstostar (USend + UGet)\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \ReceiveUnreliableP{r}{3}{4}{l1b}{\perp}{v_3}.\If{\anyNack{\VectorV} \tOr \promiseCount{\VectorV} < 1} \Then{\dots}\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveWeaklyP{r}{4}{1}{\BeginPaCont}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveWeaklyP{r}{4}{2}{\BeginPaCont}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \SendUnreliableP{r}{3}{4}{l1b}{\Promise{\Nothing}}.\PaCont
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% $\mapstostar (USend + UGet)\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \If{\False \tOr 2 < 1} \Then{\dots} \Else{\SendWeaklyP{r}{4}{\Curly{2,3}}{\Accept}{\dots}}\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveWeaklyP{r}{4}{1}{\BeginPaCont}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveWeaklyP{r}{4}{2}{\BeginPaCont}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveWeaklyP{r}{4}{3}{\BeginPaCont}
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

$\mapstostar
\NuChannels \big (\\
\Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \SendWeaklyP{r}{4}{\Curly{2,3}}{\Accept}{\SendUnreliableP{r}{4}{2}{l2a}{\ProposalC{10}{\ABC}}}\dots \comment{= \Proposer{5}}\\
\Or \Paren{
    \Mu{X} \dots
    \Or \Mu{X} \ReceiveWeaklyP{r}{4}{1}{\BeginPaCont}
} \comment{= \Acceptor{1}}\\
\Or \Paren{
    \Mu{X} \dots
    \Or \Mu{X} \ReceiveWeaklyP{r}{4}{2}{\BeginPaCont}
} \comment{= \Acceptor{2}}\\
\Or \Paren{
    \Mu{X} \dots
    \Or \Mu{X} \ReceiveWeaklyP{r}{4}{3}{\BeginPaCont}
} \comment{= \Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

$\Proposer{5}$ broadcasts its decision $\Accept$ to $\Acceptor{2}$ and $\Acceptor{3}$.
By applying $\Wsel$ once, $\Wbran$ twice we obtain:
% corresponds to (4)

$\mapstostar
\NuChannels \big (\\
\Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \SendUnreliableP{r}{4}{2}{l2a}{\ProposalC{10}{\ABC}}.\SendUnreliableP{r}{4}{3}{l2a}{\ProposalC{10}{\ABC}}\dots \comment{= \Proposer{5}}\\
\Or \Paren{
    \Mu{X} \dots
    \Or \Mu{X} \ReceiveWeaklyP{r}{4}{1}{\BeginPaCont}
} \comment{= \Acceptor{1}}\\
\Or \Paren{
    \Mu{X} \dots
    \Or \Mu{X} \ReceiveUnreliableP{r}{4}{2}{l2a}{\perp}{pr'}.\If{\dots}
} \comment{= \Acceptor{2}}\\
\Or \Paren{
    \Mu{X} \dots
    \Or \Mu{X} \ReceiveUnreliableP{r}{4}{3}{l2a}{\perp}{pr'}.\If{\dots}
} \comment{= \Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

% $\mapstostar (WSkip)\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \SendUnreliableP{r}{4}{2}{l2a}{\ProposalC{\proposalNumber{5}{6}}{\promValue{\VectorV}}}.\\\hspace*{1em}\SendUnreliableP{r}{4}{3}{l2a}{\ProposalC{\proposalNumber{5}{6}}{\promValue{\VectorV}}}\dots\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} end
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveUnreliableP{r}{4}{2}{l2a}{\perp}{pr'}.\If{\dots}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveUnreliableP{r}{4}{3}{l2a}{\perp}{pr'}.\If{\dots}
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% $\mapstostar (USend + UGet)\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \SendUnreliableP{r}{4}{3}{l2a}{\ProposalC{\proposalNumber{5}{6}}{\promValue{\VectorV}}}.end\\
% \Or \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \If{\ProposalC{10}{\ABC} = \perp} \Then{X} \Else{\dots}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \ReceiveUnreliableP{r}{4}{3}{l2a}{\perp}{pr'}.\If{\dots}
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% $\mapstostar (USend + UGet)\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} end\\
% \Or \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \If{\ProposalC{10}{\ABC} = \perp} \Then{X} \Else{\dots}
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} \If{\ProposalC{10}{\ABC} = \perp} \Then{X} \Else{\dots}
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% $=\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}\\
% \Or (
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \\\hspace*{1em}\Or \Mu{X} \If{\greaterEqual{10}{10}} \Then{\update{pr}{pr'}.\update{n}{\Just{10}}.X} \Else{\dots}
% )\\
% \Or (
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \\\hspace*{1em}\Or \Mu{X} \If{\greaterEqual{10}{10}} \Then{\update{pr}{pr'}.\update{n}{\Just{10}}.X} \Else{\dots}
% )\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% % A1: n=Nothing, pr=Nothing
% % A2: n=10, pr=Proposal 10 abc
% % A3: n=10, pr=Proposal 10 abc
% $=\\
% \NuChannels \big (
% \Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots\\
% \Or \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots}\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} X
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots}
%     \Or \Mu{X} X
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

Now $\Proposer{5}$ can send its proposal to $\Acceptor{2}$ and $\Acceptor{3}$ and terminate.
To do so we apply $\Usend$ and $\Uget$ twice.
$\Acceptor{2}$ and $\Acceptor{3}$ accept the proposal and the respective subprocesses terminate.
Note that we apply $\Wskip$ in $\Acceptor{1}$ and terminate that subprocess as well.
% corresponds to (5)

$\mapstostar
\NuChannels \big (\\
\Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{\proposalNumber{5}{4}}.\SendUnreliableP{s}{4}{2}{l1a}{\proposalNumber{5}{4}}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots} \comment{= \Acceptor{1}}\\
\Or \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots} \comment{= \Acceptor{2}}\\
\Or \Mu{X} \ReceiveUnreliableP{s}{4}{3}{l1a}{\perp}{n'}.\If{\dots} \comment{= \Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

At this point the local variables of $\Acceptor{2}$ and $\Acceptor{3}$ are $n = 10$ and $pr = \ProposalC{10}{\ABC}$.
$\Acceptor{1}$ has not updated its local variables $n = \Nothing$ and $pr = \Nothing$.

\subsubsection{Restarting the Algorithm}
Next, $\Proposer{4}$ sends prepare requests with a proposal number less than 10, which is rejected by $\Acceptor{2}$.
$\Proposer{4}$ then decides to restart the algorithm.
We apply $\Usend$ and $\Uget$ twice.
We also apply $\Uskip$ once in $\Acceptor{3}$.

$\mapstostar
\NuChannels \big (\\
\Mu{X} \ReceiveUnreliableP{s}{1}{4}{l1b}{\perp}{v_1}.\ReceiveUnreliableP{s}{2}{4}{l1b}{\perp}{v_2}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \If{5 = \perp} \Then{\PaCont} \Else{\dots} \comment{= \Acceptor{1}}\\
\Or \Mu{X} \If{5 = \perp} \Then{\PaCont} \Else{\dots} \comment{= \Acceptor{2}}\\
\Or \Mu{X} \If{\perp = \perp} \Then{\PaCont} \Else{\dots} \comment{= \Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

$\Acceptor{3}$ moves directly to $\PaCont$ whereas $\Acceptor{1}$ and $\Acceptor{2}$ send their responses to $\Proposer{4}$ before moving to $\PaCont$.
$\Acceptor{1}$ also updates its local variable $n = 5$.

% $=\\
% \NuChannels \big (
% \Mu{X} \ReceiveUnreliableP{s}{1}{4}{l1b}{\perp}{v_1}.\ReceiveUnreliableP{s}{2}{4}{l1b}{\perp}{v_2}\dots\\
% \Or \Mu{X} \If{\greaterThan{5}{\Nothing}} \Then{\update{n}{5}\dots}\Else{\dots}\\
% \Or \Paren{
%     \Mu{X} \If{\greaterThan{5}{\Just{10}}} \Then{\dots} \Else{\SendUnreliableP{s}{2}{4}{l1b}{\Nack{10}}.\PaCont}
%     \Or \Mu{X} X
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveWeaklyP{r}{4}{3}{\BeginPaCont}
%     \Or \Mu{X} X
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% A1: n=5, pr=Nothing
% A2: n=10, pr=Proposal 10 abc
% A3: n=10, pr=Proposal 10 abc
$=
\NuChannels \big (\\
\Mu{X} \ReceiveUnreliableP{s}{1}{4}{l1b}{\perp}{v_1}.\ReceiveUnreliableP{s}{2}{4}{l1b}{\perp}{v_2}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \SendUnreliableP{s}{1}{4}{l1b}{\Promise{\Nothing}}.\PaCont \comment{= \Acceptor{1}}\\
\Or \Mu{X} \SendUnreliableP{s}{2}{4}{l1b}{\Nack{10}}.\PaCont \comment{= \Acceptor{2}}\\
\Or \Mu{X} \ReceiveWeaklyP{r}{4}{3}{\BeginPaCont} \comment{= \Acceptor{3}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

% $\mapstostar (USend + UGet, USend + UGet)\\
% \NuChannels \big (
% \Mu{X} \If{\True \tOr 1 < 1} \Then{\SendWeaklyP{s}{4}{\Curly{1,2}}{\Restart}{X}} \Else{\dots}\\
% \Or \Mu{X} \ReceiveWeaklyP{s}{4}{1}{\BeginPaCont}\\
% \Or \Paren{
%     \Mu{X} \ReceiveWeaklyP{s}{4}{1}{\BeginPaCont}
%     \Or \Mu{X} X
% }\\
% \Or \Paren{
%     \Mu{X} \ReceiveWeaklyP{r}{4}{3}{\BeginPaCont}
%     \Or \Mu{X} X
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

Applying $\Usend$ and $\Uget$ twice and evaluating the branching in $\Proposer{4}$ yields:

$\mapstostar
\NuChannels \big (\\
\Mu{X} \SendWeaklyP{s}{4}{\Curly{1,2}}{\Restart}{X}\\
\Or \Mu{X} \ReceiveWeaklyP{s}{4}{1}{\BeginPaCont}\\
\Or \Mu{X} \ReceiveWeaklyP{s}{4}{1}{\BeginPaCont}\\
\Or \Mu{X} \ReceiveWeaklyP{r}{4}{3}{\BeginPaCont}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

% $\mapstostar (WSel + WBran, WSkip)\\
% \NuChannels \big (
% \Mu{X} X\\
% \Or \Mu{X} X\\
% \Or \Paren{
%     \Mu{X} X
%     \Or \Mu{X} X
% }\\
% \Or \Paren{
%     \Mu{X} end
%     \Or \Mu{X} X
% }\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

$\Proposer{4}$ sends its decision to restart the algorithm to $\Acceptor{1}$ and $\Acceptor{2}$ by applying $\Wsel$ once and $\Wbran$ twice.
$\Acceptor{3}$ terminates after applying $\Wskip$.

$\mapstostar
\NuChannels \big (\\
\Mu{X} \SendUnreliableP{s}{4}{1}{l1a}{15}.\SendUnreliableP{s}{4}{2}{l1a}{15}\dots \comment{= \Proposer{4}}\\
\Or \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l1a}{\perp}{n'}.\If{\dots} \comment{= \Acceptor{1}}\\
\Or \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l1a}{\perp}{n'}.\If{\dots} \comment{= \Acceptor{2}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

% $\mapstostar (USend + UGet, USend + UGet)\\
% \NuChannels \big (
% \Mu{X} \ReceiveUnreliableP{s}{1}{4}{l1b}{\perp}{v_1}.\ReceiveUnreliableP{s}{2}{4}{l1b}{\perp}{v_2}.\If{\dots}\\
% \Or \Mu{X} \If{15 = \perp} \Then{\PaCont} \Else{\dots}\\
% \Or \Paren{
%     \Mu{X} \If{15 = \perp} \Then{\PaCont} \Else{\dots}
%     \Or \Mu{X} X
% }\\
% \Or \Mu{X} X\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% % A1: n=5, pr=Nothing
% % A2: n=10, pr=Proposal 10 abc
% % A3: n=10, pr=Proposal 10 abc
% $\mapstostar
% \NuChannels \big (\\
% \Mu{X} \ReceiveUnreliableP{s}{1}{4}{l1b}{\perp}{v_1}.\ReceiveUnreliableP{s}{2}{4}{l1b}{\perp}{v_2}.\If{\dots}\\
% \Or \Mu{X} \If{\greaterThan{15}{\Just{5}}} \Then{\update{n}{15}\dots} \Else{\dots}\\
% \Or \Mu{X} \If{\greaterThan{15}{\Just{10}}} \Then{\update{n}{15}\dots} \Else{\dots}\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

\subsubsection{The Happy Path, Again}

This time $\Proposer{4}$ uses a high enough proposal number so that $\Acceptor{1}$ and $\Acceptor{2}$ both promise not to accept any proposal numbered less than that.
By applying $\Usend$ and $\Uget$ and evaluating the branches in the remaining acceptors we arrive at:

% A1: n=15, pr=Nothing
% A2: n=15, pr=Proposal 10 abc
% A3: n=10, pr=Proposal 10 abc
$\mapstostar
\NuChannels \big (\\
\Mu{X} \ReceiveUnreliableP{s}{1}{4}{l1b}{\perp}{v_1}.\ReceiveUnreliableP{s}{2}{4}{l1b}{\perp}{v_2}.\If{\dots} \comment{= \Proposer{4}}\\
\Or \Mu{X} \SendUnreliableP{s}{1}{4}{l1b}{\Promise{\Nothing}}.\PaCont \comment{= \Acceptor{1}}\\
\Or \Mu{X} \SendUnreliableP{s}{2}{4}{l1b}{\Promise{\ProposalC{10}{abc}}}.\PaCont \comment{= \Acceptor{2}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

Note that, at this point, $\Acceptor{1}$ and $\Acceptor{2}$ have updated their respective $n$ to $15$.

Because $\Acceptor{2}$ has already accepted a proposal, it responds to $\Proposer{4}$'s prepare request with that proposal.
Twice more we apply $\Usend$ and $\Uget$ and evaluate the branch in $\Proposer{4}$ to obtain:

% % A1: n=15, pr=Nothing
% % A2: n=15, pr=Proposal 10 abc
% % A3: n=10, pr=Proposal 10 abc
% $\mapstostar (USend + UGet, USend + UGet)\\
% \NuChannels \big (
% \Mu{X} \If{\False \tOr 2 < 1} \Then{\dots} \Else{\SendWeaklyP{s}{4}{\Curly{1,2}}{\Accept}{\dots}}\\
% \Or \Mu{X} \ReceiveWeaklyP{s}{4}{1}{\BeginPaCont}\\
% \Or \Paren{
%     \Mu{X} \ReceiveWeaklyP{s}{4}{1}{\BeginPaCont}
%     \Or \Mu{X} X
% }\\
% \Or \Mu{X} X\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% A1: n=15, pr=Nothing
% A2: n=15, pr=Proposal 10 abc
% A3: n=10, pr=Proposal 10 abc
$\mapstostar
\NuChannels \big (\\
\Mu{X} \SendWeaklyP{s}{4}{\Curly{1,2}}{\Accept}{\dots} \comment{= \Proposer{4}}\\
\Or \Mu{X} \ReceiveWeaklyP{s}{4}{1}{\BeginPaCont} \comment{= \Acceptor{1}}\\
\Or \Mu{X} \ReceiveWeaklyP{s}{4}{1}{\BeginPaCont} \comment{= \Acceptor{2}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

$\Proposer{4}$ has received enough promises to send its own proposal.
The value for that proposal is $\ABC$ because that is the value of the highest-numbered proposal $\Proposer{4}$ received as a response to its prepare request.
First, we apply $\Wsel$ and $\Wbran$.

% A1: n=15, pr=Nothing
% A2: n=15, pr=Proposal 10 abc
% A3: n=10, pr=Proposal 10 abc
$\mapstostar
\NuChannels \big (\\
\Mu{X} \SendUnreliableP{s}{4}{1}{l2a}{\ProposalC{15}{\ABC}}.
\SendUnreliableP{s}{4}{2}{l2a}{\ProposalC{15}{\ABC}}.end \comment{= \Proposer{4}}\\
\Or \Mu{X} \ReceiveUnreliableP{s}{4}{1}{l2a}{\perp}{pr'}.\If{\dots}\comment{= \Acceptor{1}}\\
\Or \Mu{X} \ReceiveUnreliableP{s}{4}{2}{l2a}{\perp}{pr'}.\If{\dots}\comment{= \Acceptor{2}}\\
\Or \InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

Then we apply $\Usend$ and $\Uget$ to send the proposal from $\Proposer{4}$ to the acceptors.
$\Proposer{4}$ terminates and the acceptors accept the received proposal and then terminate as well.

% % A1: n=15, pr=Nothing
% % A2: n=15, pr=Proposal 10 abc
% % A3: n=10, pr=Proposal 10 abc
% $\mapstostar (USend + UGet, USend + UGet)\\
% \NuChannels \big (
% \Mu{X} end\\
% \Or \Mu{X} \If{\ProposalC{15}{\ProposalC{15}{abc}} = \perp} \Then{\dots} \Else{\dots}\\
% \Or \Paren{
%     \Mu{X} \If{\ProposalC{15}{\ProposalC{15}{abc}} = \perp} \Then{\dots} \Else{\dots}
%     \Or \Mu{X} X
% }\\
% \Or \Mu{X} X\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% % A1: n=15, pr=Nothing
% % A2: n=15, pr=Proposal 10 abc
% % A3: n=10, pr=Proposal 10 abc
% $=\\
% \NuChannels \big (
% \Or \Mu{X} \If{\greaterEqual{15}{\Just{15}}}\\\hspace*{1em}\Then{\update{pr}{\ProposalC{15}{abc}}.\update{n}{15}.X} \Else{\dots}\\
% \Or (
%     \Mu{X} \If{\greaterEqual{15}{\Just{15}}}\\\hspace*{1em}\Then{\update{pr}{\ProposalC{15}{abc}}.\update{n}{15}.X} \Else{\dots}
%     \Or \Mu{X} X
% )\\
% \Or \Mu{X} X\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% % A1: n=15, pr=Proposal 15 abc
% % A2: n=15, pr=Proposal 15 abc
% % A3: n=10, pr=Proposal 10 abc
% $=\\
% \NuChannels \big (
% \Or \Mu{X} X\\
% \Or \Paren{
%     \Mu{X} X
%     \Or \Mu{X} X
% }\\
% \Or \Mu{X} X\\
% \Or \InnerSessionQueues{s}
% \Or \InnerSessionQueues{r}
% \Or \OuterSessionQueues
% \big )$

% A1: n=15, pr=Proposal 15 abc
% A2: n=15, pr=Proposal 15 abc
% A3: n=10, pr=Proposal 10 abc
$\mapstostar
\NuChannels \big (\InnerSessionQueues{s}
\Or \InnerSessionQueues{r}
\Or \OuterSessionQueues
\big )$

Afterwards $\Acceptor{1}$ and $\Acceptor{2}$ have $n = 15$ and $pr = \ProposalC{15}{\ABC}$ and $\Acceptor{3}$ has $n = 10$ and $pr = \ProposalC{10}{\ABC}$.
All acceptors have accepted the value $\ABC$.

% % A1: n=15, pr=Proposal 15 abc
% % A2: n=15, pr=Proposal 15 abc
% % A3: n=10, pr=Proposal 10 abc
% $=\\
% \NuChannels \Paren{
%     \Or \InnerSessionQueues{s}
%     \Or \InnerSessionQueues{r}
%     \Or \OuterSessionQueues
% }$


